!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).WebRTCPeer=e()}}(function(){return function(){return function e(t,n,r){function i(s,a){if(!n[s]){if(!t[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var l=n[s]={exports:{}};t[s][0].call(l.exports,function(e){return i(t[s][1][e]||e)},l,l.exports,e,t,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}}()({1:[function(e,t,n){var r=Object.create||function(e){var t=function(){};return t.prototype=e,new t},i=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return n},o=Function.prototype.bind||function(e){var t=this;return function(){return t.apply(e,arguments)}};function s(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=r(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}t.exports=s,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._maxListeners=void 0;var a,c=10;try{var u={};Object.defineProperty&&Object.defineProperty(u,"x",{value:0}),a=0===u.x}catch(e){a=!1}function l(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function f(e,t,n,i){var o,s,a;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),a=s[t]):(s=e._events=r(null),e._eventsCount=0),a){if("function"==typeof a?a=s[t]=i?[n,a]:[a,n]:i?a.unshift(n):a.push(n),!a.warned&&(o=l(e))&&o>0&&a.length>o){a.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+a.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=a.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",c.name,c.message)}}else a=s[t]=n,++e._eventsCount;return e}function d(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=new Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function h(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=o.call(d,r);return i.listener=n,r.wrapFn=i,i}function _(e,t,n){var r=e._events;if(!r)return[];var i=r[t];return i?"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):C(i,i.length):[]}function p(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function C(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}a?Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||e!=e)throw new TypeError('"defaultMaxListeners" must be a positive number');c=e}}):s.defaultMaxListeners=c,s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return l(this)},s.prototype.emit=function(e){var t,n,r,i,o,s,a="error"===e;if(s=this._events)a=a&&null==s.error;else if(!a)return!1;if(a){if(arguments.length>1&&(t=arguments[1]),t instanceof Error)throw t;var c=new Error('Unhandled "error" event. ('+t+")");throw c.context=t,c}if(!(n=s[e]))return!1;var u="function"==typeof n;switch(r=arguments.length){case 1:!function(e,t,n){if(t)e.call(n);else for(var r=e.length,i=C(e,r),o=0;o<r;++o)i[o].call(n)}(n,u,this);break;case 2:!function(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,o=C(e,i),s=0;s<i;++s)o[s].call(n,r)}(n,u,this,arguments[1]);break;case 3:!function(e,t,n,r,i){if(t)e.call(n,r,i);else for(var o=e.length,s=C(e,o),a=0;a<o;++a)s[a].call(n,r,i)}(n,u,this,arguments[1],arguments[2]);break;case 4:!function(e,t,n,r,i,o){if(t)e.call(n,r,i,o);else for(var s=e.length,a=C(e,s),c=0;c<s;++c)a[c].call(n,r,i,o)}(n,u,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),o=1;o<r;o++)i[o-1]=arguments[o];!function(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,o=C(e,i),s=0;s<i;++s)o[s].apply(n,r)}(n,u,this,i)}return!0},s.prototype.addListener=function(e,t){return f(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return f(this,e,t,!0)},s.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,h(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,h(this,e,t)),this},s.prototype.removeListener=function(e,t){var n,i,o,s,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(i=this._events))return this;if(!(n=i[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=r(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(o=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){a=n[s].listener,o=s;break}if(o<0)return this;0===o?n.shift():function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,o),1===n.length&&(i[e]=n[0]),i.removeListener&&this.emit("removeListener",e,a||t)}return this},s.prototype.removeAllListeners=function(e){var t,n,o;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=r(null),this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=r(null):delete n[e]),this;if(0===arguments.length){var s,a=i(n);for(o=0;o<a.length;++o)"removeListener"!==(s=a[o])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=r(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(o=t.length-1;o>=0;o--)this.removeListener(e,t[o]);return this},s.prototype.listeners=function(e){return _(this,e,!0)},s.prototype.rawListeners=function(e){return _(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},s.prototype.listenerCount=p,s.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]}},{}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var r=function(e,t){var n=new Error(e);return n.code=t,n};n.default=r,t.exports=n.default},{}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var r=function(e){var t=e||{};return{dataChannelConfig:t.dataChannelConfig||{},isInitiator:!0===t.isInitiator,isTrickleIceEnabled:!(!1===t.isTrickleIceEnabled),peerConnectionConfig:function(e){var t=e.peerConnectionConfig||{};return Array.isArray(t.iceServers)||(t.iceServers=[]),t}(t),sdpTransformer:function(e){return"function"==typeof e.sdpTransformer?e.sdpTransformer:function(e){return e}}(t),streams:function(e){return Array.isArray(e.streams)?e.streams:[]}(t)}};n.default=r,t.exports=n.default},{}],4:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.WEBRTC_SUPPORT=n.SIGNALING=n.SET_REMOTE_DESCRIPTION=n.SET_LOCAL_DESCRIPTION=n.REMOVE_TRACK=n.PEER_IS_DESTROYED=n.ICE_CONNECTION_FAILURE=n.ICE_CONNECTION_CLOSED=n.DATA_CHANNEL=n.CREATE_OFFER=n.CREATE_ANSWER=n.ADD_ICE_CANDIDATE=void 0;n.ADD_ICE_CANDIDATE="ERR_ADD_ICE_CANDIDATE";n.CREATE_ANSWER="ERR_CREATE_ANSWER";n.CREATE_OFFER="ERR_CREATE_OFFER";n.DATA_CHANNEL="ERR_DATA_CHANNEL";n.ICE_CONNECTION_CLOSED="ERR_ICE_CONNECTION_CLOSED";n.ICE_CONNECTION_FAILURE="ERR_ICE_CONNECTION_FAILURE";n.PEER_IS_DESTROYED="ERR_PEER_IS_DESTROYED";n.REMOVE_TRACK="ERR_REMOVE_TRACK";n.SET_LOCAL_DESCRIPTION="ERR_SET_LOCAL_DESCRIPTION";n.SET_REMOTE_DESCRIPTION="ERR_SET_REMOTE_DESCRIPTION";n.SIGNALING="ERR_SIGNALING";n.WEBRTC_SUPPORT="ERR_WEBRTC_SUPPORT"},{}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var r=e("events"),i=a(e("./create-error")),o=a(e("./create-options")),s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var r=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,n):{};r.get||r.set?Object.defineProperty(t,n,r):t[n]=e[n]}return t.default=e,t}(e("./error-codes"));function a(e){return e&&e.__esModule?e:{default:e}}function c(e){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var h=function(e){function t(e){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=d(d(n=function(e,t){return!t||"object"!==c(t)&&"function"!=typeof t?d(e):t}(this,l(t).call(this))));return r._checkWebRTCSupport(),r._options=(0,o.default)(e),r._isConnected=!1,r._isDestroyed=!1,r._isIceComplete=!1,r._isNegotiating=!1,r._shouldRenegotiate=!1,r._peerConnection=null,r._dataChannel=null,r._remoteStreamIds=new Set,r._mediaTracksMap=new Map,r._setUpPeerConnection(),n}var n,a,h;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,r.EventEmitter),n=t,(a=[{key:"addStream",value:function(e){var t=this;e.getTracks().forEach(function(n){return t.addTrack(n,e)})}},{key:"addTrack",value:function(e,t){var n=this._peerConnection.addTrack(e,t);this._mediaTracksMap.set(e,n)}},{key:"destroy",value:function(e){this._isDestroyed||(this._isConnected=!1,this._isDestroyed=!0,this._removeDataChannelHandlers(),this._removePeerConnectionHandlers(),this._dataChannel=null,this._peerConnection=null,this._mediaTracksMap=null,this._remoteStreamIds=null,e&&this.emit("error",e),this.emit("close"))}},{key:"getStats",value:function(){if(this._isDestroyed)throw(0,i.default)("cannot getStats after peer is destroyed",s.PEER_IS_DESTROYED);return this._peerConnection.getStats()}},{key:"isConnected",value:function(){return this._isConnected}},{key:"isDestroyed",value:function(){return this._isDestroyed}},{key:"removeStream",value:function(e){var t=this;e.getTracks().forEach(function(e){return t.removeTrack(e)})}},{key:"removeTrack",value:function(e){if(!this._mediaTracksMap.has(e))throw(0,i.default)("cannot remove track that was never added",s.REMOVE_TRACK);var t=this._mediaTracksMap.get(e);this._peerConnection.removeTrack(t)}},{key:"send",value:function(e){if(this._isDestroyed)throw(0,i.default)("cannot getStats after peer is destroyed",s.PEER_IS_DESTROYED);this._dataChannel.send(e)}},{key:"signal",value:function(e){var t=this;if(t._isDestroyed)throw(0,i.default)("cannot signal after peer is destroyed",s.SIGNALING);var n=e;if("string"==typeof e)try{n=JSON.parse(e)}catch(e){n={}}if(n.candidate)t._peerConnection.addIceCandidate(n.candidate).catch(function(e){var n=(0,i.default)(e,s.ADD_ICE_CANDIDATE);t.destroy(n)});else if(n.sdp)t._setRemoteDescription(n);else if(n.renegotiate)t._onNegotiationNeeded();else{var r=(0,i.default)("signal called with invalid signal data",s.SIGNALING);t.destroy(r)}}},{key:"_setRemoteDescription",value:function(e){var t=this;t._peerConnection.setRemoteDescription(e).catch(function(e){var n=(0,i.default)(e,s.SET_REMOTE_DESCRIPTION);t.destroy(n)}).then(function(){if(t._isDestroyed)return;"offer"===e.type&&t._createAnswer()})}},{key:"_setUpPeerConnection",value:function(){var e=this;this._peerConnection=new window.RTCPeerConnection(this._options.peerConnectionConfig),this._addPeerConnectionHandlers(),this._setUpDefaultDataChannel(),this._options.streams.forEach(function(t){return e.addStream(t)})}},{key:"_addPeerConnectionHandlers",value:function(){var e=this;e._peerConnection.onicecandidate=function(t){e._onIceCandidate(t)},e._peerConnection.oniceconnectionstatechange=function(){e._onIceConnectionStateChange()},e._peerConnection.onicegatheringstatechange=function(){e._onIceGatheringStateChange()},e._peerConnection.onnegotiationneeded=function(){e._onNegotiationNeeded()},e._peerConnection.onsignalingstatechange=function(){e._onSignalingStateChange()},e._peerConnection.ontrack=function(t){e._onTrack(t)}}},{key:"_setUpDefaultDataChannel",value:function(){var e=this;if(e._options.isInitiator){var t=e._peerConnection.createDataChannel(null,e._options.dataChannelConfig);e._assignDataChannel({channel:t})}else e._peerConnection.ondatachannel=function(t){e._assignDataChannel(t)}}},{key:"_onNegotiationNeeded",value:function(){this._options.isInitiator?this._isNegotiating?this._shouldRenegotiate=!0:this._createOffer():this.emit("signal",{renegotiate:!0}),this._isNegotiating=!0}},{key:"_createAnswer",value:function(){var e=this;function t(){e.emit("signal",e._peerConnection.localDescription)}e._isDestroyed||e._peerConnection.createAnswer().catch(function(t){var n=(0,i.default)(t,s.CREATE_ANSWER);e.destroy(n)}).then(function(t){if(e._isDestroyed)return;return t.sdp=e._options.sdpTransformer(t.sdp),e._peerConnection.setLocalDescription(t)}).catch(function(t){var n=(0,i.default)(t,s.SET_LOCAL_DESCRIPTION);e.destroy(n)}).then(function(n){if(e._isDestroyed)return;e._options.isTrickleIceEnabled||e._isIceComplete?t():e.once("_iceComplete",t)})}},{key:"_onSignalingStateChange",value:function(){this._isDestroyed||"stable"===this._peerConnection.signalingState&&(this._isNegotiating=!1,this._shouldRenegotiate&&(this._shouldRenegotiate=!1,this._onNegotiationNeeded()))}},{key:"_onTrack",value:function(e){var t=this;t._isDestroyed||e.streams.forEach(function(n){n.onremovetrack=function(e){t._isDestroyed||(!n.active&&t._remoteStreamIds.has(n.id)&&(t._remoteStreamIds.delete(n.id),setTimeout(function(){t.emit("removestream",n)},0)),t.emit("removetrack",e.track,e.target))},setTimeout(function(){t.emit("track",e.track,n)},0),t._remoteStreamIds.has(n.id)||(t._remoteStreamIds.add(n.id),setTimeout(function(){t.emit("stream",n)},0))})}},{key:"_onIceCandidate",value:function(e){if(!this._isDestroyed&&e.candidate&&this._options.isTrickleIceEnabled){var t={candidate:e.candidate};this.emit("signal",t)}}},{key:"_onIceGatheringStateChange",value:function(){this._isDestroyed||("complete"===this._peerConnection.iceGatheringState?(this._isIceComplete=!0,this.emit("_iceComplete")):this._isIceComplete=!1)}},{key:"_onIceConnectionStateChange",value:function(){if(!this._isDestroyed){var e=this._peerConnection.iceConnectionState;"failed"===e?this.destroy((0,i.default)("Ice connection failed.",s.ICE_CONNECTION_FAILURE)):"closed"===e&&this.destroy((0,i.default)("ice connection closed",s.ICE_CONNECTION_CLOSED))}}},{key:"_createOffer",value:function(){var e=this;if(!e._isDestroyed){e._acceptIncomingVideoAndAudio();var t="getTransceivers"in window.RTCPeerConnection.prototype?{}:{offerToReceiveAudio:!0,offerToReceiveVideo:!0};e._peerConnection.createOffer(t).catch(function(t){e.destroy((0,i.default)(t,s.CREATE_OFFER))}).then(function(t){if(e._isDestroyed)return;return t.sdp=e._options.sdpTransformer(t.sdp),e._peerConnection.setLocalDescription(t)}).catch(function(t){e.destroy((0,i.default)(t,s.SET_LOCAL_DESCRIPTION))}).then(function(t){if(e._isDestroyed)return;e._options.isTrickleIceEnabled||e._isIceComplete?n():e.once("_iceComplete",n)})}function n(){e.emit("signal",e._peerConnection.localDescription)}}},{key:"_acceptIncomingVideoAndAudio",value:function(){if("getTransceivers"in window.RTCPeerConnection.prototype){var e=this._peerConnection.getTransceivers().find(function(e){return e.sender.track&&"audio"===e.sender.track.kind}),t=this._peerConnection.getTransceivers().find(function(e){return e.sender.track&&"video"===e.sender.track.kind});null==e&&this._peerConnection.addTransceiver("audio"),null==t&&this._peerConnection.addTransceiver("video")}}},{key:"_assignDataChannel",value:function(e){var t=this;t._dataChannel=e.channel,t._dataChannel.binaryType="arraybuffer",t._dataChannel.onclose=function(){t._onChannelClose()},t._dataChannel.onerror=function(e){var n=e.message,r=s.DATA_CHANNEL,o=(0,i.default)(n,r);t.destroy(o)},t._dataChannel.onmessage=function(e){t._onChannelMessage(e)},t._dataChannel.onopen=function(){t._onChannelOpen()}}},{key:"_onChannelOpen",value:function(){this._isConnected||this._isDestroyed||(this._isConnected=!0,this.emit("connect"))}},{key:"_onChannelMessage",value:function(e){this._isDestroyed||this.emit("data",e.data)}},{key:"_onChannelClose",value:function(){this._isDestroyed||this.destroy()}},{key:"_removeDataChannelHandlers",value:function(){if(this._dataChannel){try{this._dataChannel.close()}catch(e){}this._dataChannel.onclose=null,this._dataChannel.onerror=null,this._dataChannel.onmessage=null,this._dataChannel.onopen=null}}},{key:"_removePeerConnectionHandlers",value:function(){if(this._peerConnection){try{this._peerConnection.close()}catch(e){}this._peerConnection.onicecandidate=null,this._peerConnection.oniceconnectionstatechange=null,this._peerConnection.onicegatheringstatechange=null,this._peerConnection.onnegotiationneeded=null,this._peerConnection.onsignalingstatechange=null,this._peerConnection.ontrack=null,this._peerConnection.ondatachannel=null}}},{key:"_checkWebRTCSupport",value:function(){if("undefined"==typeof window)throw(0,i.default)("WebRTC is not supported in this environment",s.WEBRTC_SUPPORT);if(null==window.RTCPeerConnection)throw(0,i.default)("WebRTC is not supported in this browser",s.WEBRTC_SUPPORT);"createDataChannel"in window.RTCPeerConnection.prototype||console.log("webrtc-peer :: data channel is not supported in this browser")}}])&&u(n.prototype,a),h&&u(n,h),t}();n.default=h,t.exports=n.default},{"./create-error":2,"./create-options":3,"./error-codes":4,events:1}]},{},[5])(5)});