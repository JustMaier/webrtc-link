!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).WebRTCPeer=e()}}(function(){return function(){return function e(t,n,i){function r(s,a){if(!n[s]){if(!t[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var h=n[s]={exports:{}};t[s][0].call(h.exports,function(e){return r(t[s][1][e]||e)},h,h.exports,e,t,n,i)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}}()({1:[function(e,t,n){var i=Object.create||function(e){var t=function(){};return t.prototype=e,new t},r=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return n},o=Function.prototype.bind||function(e){var t=this;return function(){return t.apply(e,arguments)}};function s(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=i(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}t.exports=s,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._maxListeners=void 0;var a,c=10;try{var l={};Object.defineProperty&&Object.defineProperty(l,"x",{value:0}),a=0===l.x}catch(e){a=!1}function h(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function d(e,t,n,r){var o,s,a;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),a=s[t]):(s=e._events=i(null),e._eventsCount=0),a){if("function"==typeof a?a=s[t]=r?[n,a]:[a,n]:r?a.unshift(n):a.push(n),!a.warned&&(o=h(e))&&o>0&&a.length>o){a.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+a.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=a.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",c.name,c.message)}}else a=s[t]=n,++e._eventsCount;return e}function u(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=new Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function _(e,t,n){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},r=o.call(u,i);return r.listener=n,i.wrapFn=r,r}function f(e,t,n){var i=e._events;if(!i)return[];var r=i[t];return r?"function"==typeof r?n?[r.listener||r]:[r]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(r):C(r,r.length):[]}function p(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function C(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e[i];return n}a?Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||e!=e)throw new TypeError('"defaultMaxListeners" must be a positive number');c=e}}):s.defaultMaxListeners=c,s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return h(this)},s.prototype.emit=function(e){var t,n,i,r,o,s,a="error"===e;if(s=this._events)a=a&&null==s.error;else if(!a)return!1;if(a){if(arguments.length>1&&(t=arguments[1]),t instanceof Error)throw t;var c=new Error('Unhandled "error" event. ('+t+")");throw c.context=t,c}if(!(n=s[e]))return!1;var l="function"==typeof n;switch(i=arguments.length){case 1:!function(e,t,n){if(t)e.call(n);else for(var i=e.length,r=C(e,i),o=0;o<i;++o)r[o].call(n)}(n,l,this);break;case 2:!function(e,t,n,i){if(t)e.call(n,i);else for(var r=e.length,o=C(e,r),s=0;s<r;++s)o[s].call(n,i)}(n,l,this,arguments[1]);break;case 3:!function(e,t,n,i,r){if(t)e.call(n,i,r);else for(var o=e.length,s=C(e,o),a=0;a<o;++a)s[a].call(n,i,r)}(n,l,this,arguments[1],arguments[2]);break;case 4:!function(e,t,n,i,r,o){if(t)e.call(n,i,r,o);else for(var s=e.length,a=C(e,s),c=0;c<s;++c)a[c].call(n,i,r,o)}(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(r=new Array(i-1),o=1;o<i;o++)r[o-1]=arguments[o];!function(e,t,n,i){if(t)e.apply(n,i);else for(var r=e.length,o=C(e,r),s=0;s<r;++s)o[s].apply(n,i)}(n,l,this,r)}return!0},s.prototype.addListener=function(e,t){return d(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return d(this,e,t,!0)},s.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,_(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,_(this,e,t)),this},s.prototype.removeListener=function(e,t){var n,r,o,s,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=i(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(o=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){a=n[s].listener,o=s;break}if(o<0)return this;0===o?n.shift():function(e,t){for(var n=t,i=n+1,r=e.length;i<r;n+=1,i+=1)e[n]=e[i];e.pop()}(n,o),1===n.length&&(r[e]=n[0]),r.removeListener&&this.emit("removeListener",e,a||t)}return this},s.prototype.removeAllListeners=function(e){var t,n,o;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=i(null),this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=i(null):delete n[e]),this;if(0===arguments.length){var s,a=r(n);for(o=0;o<a.length;++o)"removeListener"!==(s=a[o])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=i(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(o=t.length-1;o>=0;o--)this.removeListener(e,t[o]);return this},s.prototype.listeners=function(e){return f(this,e,!0)},s.prototype.rawListeners=function(e){return f(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},s.prototype.listenerCount=p,s.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]}},{}],2:[function(e,t,n){"use strict";t.exports=function(e,t){const n=new Error(e);return n.code=t,n}},{}],3:[function(e,t,n){"use strict";n.ADD_ICE_CANDIDATE="ERR_ADD_ICE_CANDIDATE",n.CREATE_ANSWER="ERR_CREATE_ANSWER",n.CREATE_OFFER="ERR_CREATE_OFFER",n.DATA_CHANNEL="ERR_DATA_CHANNEL",n.ICE_CONNECTION_CLOSED="ERR_ICE_CONNECTION_CLOSED",n.ICE_CONNECTION_FAILURE="ERR_ICE_CONNECTION_FAILURE",n.PEER_IS_DESTROYED="ERR_PEER_IS_DESTROYED",n.REMOVE_TRACK="ERR_REMOVE_TRACK",n.SET_LOCAL_DESCRIPTION="ERR_SET_LOCAL_DESCRIPTION",n.SET_REMOTE_DESCRIPTION="ERR_SET_REMOTE_DESCRIPTION",n.SIGNALING="ERR_SIGNALING",n.WEBRTC_SUPPORT="ERR_WEBRTC_SUPPORT"},{}],4:[function(e,t,n){"use strict";const{EventEmitter:i}=e("events"),{isChromium:r}=e("./utils"),o=e("./create-error"),s=e("./parse-options"),a=e("./error-codes");t.exports=class extends i{constructor(e){super(),this._checkWebRTCSupport(),this._options=s(e),this._isConnected=!1,this._isDestroyed=!1,this._isIceComplete=!1,this._isNegotiating=!1,this._shouldRenegotiate=!1,this._peerConnection=null,this._dataChannel=null,this._remoteStreamIds=new Set,this._mediaTracksMap=new Map,this._setUpPeerConnection()}addStream(e){e.getTracks().forEach(t=>this.addTrack(t,e))}addTrack(e,t){const n=this._peerConnection.addTrack(e,t);this._mediaTracksMap.set(e,n)}destroy(e){const t=this;t._isDestroyed||(t._isConnected=!1,t._isDestroyed=!0,t._removeDataChannelHandlers(),t._removePeerConnectionHandlers(),t._dataChannel=null,t._peerConnection=null,t._mediaTracksMap=null,t._remoteStreamIds=null,e&&t.emit("error",e),t.emit("close"))}getStats(){if(this._isDestroyed)throw o("cannot getStats after peer is destroyed",a.PEER_IS_DESTROYED);return this._peerConnection.getStats()}isConnected(){return this._isConnected}isDestroyed(){return this._isDestroyed}removeStream(e){e.getTracks().forEach(e=>this.removeTrack(e))}removeTrack(e){if(!this._mediaTracksMap.has(e))throw o("cannot remove track that was never added or has already been removed",a.REMOVE_TRACK);const t=this._mediaTracksMap.get(e);this._peerConnection.removeTrack(t)}send(e){if(this._isDestroyed)throw o("cannot call send after peer is destroyed",a.PEER_IS_DESTROYED);this._dataChannel.send(e)}signal(e){const t=this;if(t._isDestroyed)throw o("cannot signal after peer is destroyed",a.SIGNALING);let n=e;if("string"==typeof e)try{n=JSON.parse(e)}catch(e){n={}}if(n.candidate)t._peerConnection.addIceCandidate(n.candidate).catch(function(e){const n=o(e,a.ADD_ICE_CANDIDATE);t.destroy(n)});else if(n.sdp)t._setRemoteDescription(n);else if(n.renegotiate)t._onNegotiationNeeded();else{const e=o("signal called with invalid signal data",a.SIGNALING);t.destroy(e)}}_setRemoteDescription(e){const t=this;t._peerConnection.setRemoteDescription(e).catch(function(e){const n=o(e,a.SET_REMOTE_DESCRIPTION);t.destroy(n)}).then(function(){t._isDestroyed||"offer"===e.type&&t._createAnswer()})}_setUpPeerConnection(){this._peerConnection=new window.RTCPeerConnection(this._options.peerConnectionConfig),this._addPeerConnectionHandlers(),this._setUpDefaultDataChannel(),this._options.streams.forEach(e=>this.addStream(e))}_addPeerConnectionHandlers(){const e=this;e._peerConnection.onicecandidate=function(t){e._onIceCandidate(t)},e._peerConnection.oniceconnectionstatechange=function(){e._onIceConnectionStateChange()},e._peerConnection.onicegatheringstatechange=function(){e._onIceGatheringStateChange()},e._peerConnection.onnegotiationneeded=function(){e._onNegotiationNeeded()},e._peerConnection.onsignalingstatechange=function(){e._onSignalingStateChange()},e._peerConnection.ontrack=function(t){e._onTrack(t)}}_setUpDefaultDataChannel(){const e=this;if(e._options.isInitiator){const t=null,n=e._peerConnection.createDataChannel(t,e._options.dataChannelConfig);e._assignDataChannel({channel:n})}else e._peerConnection.ondatachannel=function(t){e._assignDataChannel(t)}}_onNegotiationNeeded(){this._options.isInitiator?this._isNegotiating?this._shouldRenegotiate=!0:this._createOffer():this.emit("signal",{renegotiate:!0}),this._isNegotiating=!0}_createAnswer(){const e=this;function t(){e.emit("signal",e._peerConnection.localDescription)}e._isDestroyed||e._peerConnection.createAnswer().catch(function(t){const n=o(t,a.CREATE_ANSWER);e.destroy(n)}).then(function(t){if(!e._isDestroyed)return t.sdp=e._options.sdpTransformer(t.sdp),e._peerConnection.setLocalDescription(t)}).catch(function(t){const n=o(t,a.SET_LOCAL_DESCRIPTION);e.destroy(n)}).then(function(n){e._isDestroyed||(e._options.isTrickleIceEnabled||e._isIceComplete?t():e.once("_iceComplete",t))})}_onSignalingStateChange(){this._isDestroyed||"stable"===this._peerConnection.signalingState&&(this._isNegotiating=!1,this._shouldRenegotiate&&(this._shouldRenegotiate=!1,this._onNegotiationNeeded()))}_onTrack(e){const t=this;t._isDestroyed||e.streams.forEach(function(n){n.onremovetrack=function(e){t._isDestroyed||(!n.active&&t._remoteStreamIds.has(n.id)&&(t._remoteStreamIds.delete(n.id),setTimeout(()=>{t.emit("removestream",n)},0)),t.emit("removetrack",e.track,e.target))},setTimeout(function(){t.emit("track",e.track,n)},0),t._remoteStreamIds.has(n.id)||(t._remoteStreamIds.add(n.id),setTimeout(function(){t.emit("stream",n)},0))})}_onIceCandidate(e){if(!this._isDestroyed&&e.candidate&&this._options.isTrickleIceEnabled){const t={candidate:e.candidate};this.emit("signal",t)}}_onIceGatheringStateChange(){this._isDestroyed||("complete"===this._peerConnection.iceGatheringState?(this._isIceComplete=!0,this.emit("_iceComplete")):this._isIceComplete=!1)}_onIceConnectionStateChange(){const e=this;if(e._isDestroyed)return;const t=e._peerConnection.iceConnectionState;"failed"===t?e.destroy(o("Ice connection failed.",a.ICE_CONNECTION_FAILURE)):"closed"===t&&e.destroy(o("ice connection closed",a.ICE_CONNECTION_CLOSED))}_createOffer(){const e=this;if(e._isDestroyed)return;r||e._acceptIncomingVideoAndAudio();const t=r?{offerToReceiveAudio:!0,offerToReceiveVideo:!0}:{};function n(){e.emit("signal",e._peerConnection.localDescription)}e._peerConnection.createOffer(t).catch(function(t){e.destroy(o(t,a.CREATE_OFFER))}).then(function(t){if(!e._isDestroyed)return t.sdp=e._options.sdpTransformer(t.sdp),e._peerConnection.setLocalDescription(t)}).catch(function(t){e.destroy(o(t,a.SET_LOCAL_DESCRIPTION))}).then(function(t){e._isDestroyed||(e._options.isTrickleIceEnabled||e._isIceComplete?n():e.once("_iceComplete",n))})}_acceptIncomingVideoAndAudio(){const e=this._peerConnection.getTransceivers().find(e=>e.sender.track&&"audio"===e.sender.track.kind),t=this._peerConnection.getTransceivers().find(e=>e.sender.track&&"video"===e.sender.track.kind);null==e&&this._peerConnection.addTransceiver("audio"),null==t&&this._peerConnection.addTransceiver("video")}_assignDataChannel(e){const t=this;t._dataChannel=e.channel,t._dataChannel.binaryType="arraybuffer",t._dataChannel.onclose=function(){t._onChannelClose()},t._dataChannel.onerror=function(e){const n=e.message,i=a.DATA_CHANNEL,r=o(n,i);t.destroy(r)},t._dataChannel.onmessage=function(e){t._onChannelMessage(e)},t._dataChannel.onopen=function(){t._onChannelOpen()}}_onChannelOpen(){this._isConnected||this._isDestroyed||(this._isConnected=!0,this.emit("connect"))}_onChannelMessage(e){this._isDestroyed||this.emit("data",e.data)}_onChannelClose(){this._isDestroyed||this.destroy()}_removeDataChannelHandlers(){if(this._dataChannel){try{this._dataChannel.close()}catch(e){}this._dataChannel.onclose=null,this._dataChannel.onerror=null,this._dataChannel.onmessage=null,this._dataChannel.onopen=null}}_removePeerConnectionHandlers(){if(this._peerConnection){try{this._peerConnection.close()}catch(e){}this._peerConnection.onicecandidate=null,this._peerConnection.oniceconnectionstatechange=null,this._peerConnection.onicegatheringstatechange=null,this._peerConnection.onnegotiationneeded=null,this._peerConnection.onsignalingstatechange=null,this._peerConnection.ontrack=null,this._peerConnection.ondatachannel=null}}_checkWebRTCSupport(){if("undefined"==typeof window)throw o("WebRTC is not supported in this environment",a.WEBRTC_SUPPORT);if(null==window.RTCPeerConnection)throw o("WebRTC is not supported in this browser",a.WEBRTC_SUPPORT);"createDataChannel"in window.RTCPeerConnection.prototype||console.log("webrtc-link :: data channel is not supported in this browser")}}},{"./create-error":2,"./error-codes":3,"./parse-options":5,"./utils":6,events:1}],5:[function(e,t,n){"use strict";t.exports=function(e){const t=e||{};return{dataChannelConfig:t.dataChannelConfig||{},isInitiator:!0===t.isInitiator,isTrickleIceEnabled:!1!==t.isTrickleIceEnabled,peerConnectionConfig:function(e){const t=e.peerConnectionConfig||{};return Array.isArray(t.iceServers)||(t.iceServers=[]),t}(t),sdpTransformer:function(e){return"function"==typeof e.sdpTransformer?e.sdpTransformer:e=>e}(t),streams:function(e){return Array.isArray(e.streams)?e.streams:[]}(t)}}},{}],6:[function(e,t,n){"use strict";n.isChromium=!!window.chrome||navigator.userAgent.toLowerCase().includes("electron")},{}]},{},[4])(4)});